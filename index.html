<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vilkårsgenerator - Gen II (Markdown)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-top: 1rem; padding-bottom: 2rem; }
        .error-message { color: red; font-size: 0.875em; display: block; margin-top: 0.25rem;}
        .raw-template-preview-select, .raw-template-display, #rawPreview {
            white-space: pre-wrap;
            background-color: #f8f9fa;
            padding: 0.5rem;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            font-family: monospace;
            font-size: 0.9em;
            margin-bottom: 0.5rem;
            word-break: break-all;
        }
         #rawPreview { 
             font-family: monospace;
         }
        .readable-template-display, #livePreview {
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            background-color: #e9ecef;
            white-space: normal; 
            margin-bottom: 0.5rem;
        }
        .readable-template-display h1, #livePreview h1 { font-size: 1.5em; margin-top: 0.8em; margin-bottom: 0.4em; }
        .readable-template-display h2, #livePreview h2 { font-size: 1.3em; margin-top: 0.7em; margin-bottom: 0.3em; }
        .readable-template-display table, #livePreview table { width: auto; border-collapse: collapse; margin-bottom: 1em; margin-top: 0.5em; }
        .readable-template-display th, .readable-template-display td,
        #livePreview th, #livePreview td { border: 1px solid #ccc; padding: 0.3em 0.5em; text-align: left; vertical-align: top;}
        .readable-template-display th, #livePreview th { background-color: #f0f0f0; font-weight: bold; }
        .readable-template-display ul, .readable-template-display ol,
        #livePreview ul, #livePreview ol { padding-left: 2em; margin-bottom: 0.5em; margin-top:0.5em; }
        .readable-template-display p, #livePreview p { margin-bottom: 0.5em; margin-top: 0.5em;}


        #vilkaarModal .modal-body, #nyVilkaarTypeModal .modal-body, #retningslinjeModal .modal-body {
            max-height: 75vh; 
            overflow-y: auto;
        }
        .vilkaar-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .delete-vilkaar-btn {
            font-size: 1.2rem;
            line-height: 1;
            padding: 0.2rem 0.5rem;
        }
        .tooltip-inner {
            max-width: 500px; 
            white-space: pre-wrap;
            text-align: left;
            font-family: monospace;
            font-size: 0.85em;
            background-color: #343a40; 
            color: #f8f9fa;
        }
        .bs-tooltip-auto[data-popper-placement^=left] .tooltip-arrow::before,
        .bs-tooltip-start .tooltip-arrow::before {
            border-left-color: #343a40; 
        }
        .user-value {
            color: #0d6efd; 
            font-weight: 500; 
        }
        .placeholder-missing-value {
            color: #dc3545; 
            font-style: italic;
        }
        #retningslinjeModal table { font-size: 0.9em; }
        #retningslinjeModal th, #retningslinjeModal td { padding: 0.3rem 0.5rem; border: 1px solid #dee2e6;}
        #retningslinjeModal code { font-size: 0.95em; padding: 0.1em 0.3em; background-color: #e9ecef; border-radius: 0.2em;}
    </style>
</head>
<body>
    <div class="container">
        <header class="mb-4">
            <h1>Vilkårsgenerator - Gen II (Markdown)</h1>
            <p class="lead">Demonstrasjon med <code>&lt;placeholder&gt;</code> syntaks og støtte for Markdown-formatering i maler.</p>
        </header>

        <div class="row">
            <div class="col-md-4">
                <h2>Velg Vilkår</h2>
                <div class="mb-3">
                    <label for="vilkaarTypeSelect" class="form-label">Vilkårstype:</label>
                    <select id="vilkaarTypeSelect" class="form-select"></select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Forhåndsvisning av råtekst (template):</label>
                    <div id="rawTemplatePreviewSelect" class="raw-template-preview-select p-2 border bg-light rounded" style="min-height: 50px;"></div>
                </div>
                <button id="leggTilVilkårKnapp" class="btn btn-primary mb-2 w-100">Fyll ut og legg til vilkår</button>
                <button id="aapneNyVilkaarTypeModalKnapp" class="btn btn-outline-secondary w-100 mb-2">Legg til egen vilkårstype</button>
                <button type="button" class="btn btn-info w-100" id="aapneRetningslinjeModalKnappHovedside">Retningslinje for maler</button>
            </div>

            <div class="col-md-8">
                <h2>Valgte Vilkår</h2>
                <div id="vilkaarListe" class="list-group">
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="vilkaarModal" tabindex="-1" aria-labelledby="vilkaarModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="vilkaarModalLabel">Fyll ut vilkår</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Lukk"></button>
                </div>
                <div class="modal-body">
                    <form id="vilkaarSkjema"></form>
                    <hr>
                    <h5>Live forhåndsvisning (lesbar):</h5>
                    <div id="livePreview" class="p-2 border bg-light rounded"></div>
                    <h5 class="mt-3">Live forhåndsvisning (råtekst):</h5>
                    <div id="rawPreview" class="p-2 border bg-light rounded"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Avbryt</button>
                    <button type="button" id="lagreVilkårKnapp" class="btn btn-primary">Lagre</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="nyVilkaarTypeModal" tabindex="-1" aria-labelledby="nyVilkaarTypeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg"> 
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="nyVilkaarTypeModalLabel">Legg til ny vilkårstype</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Lukk"></button>
                </div>
                <div class="modal-body">
                    <form id="nyVilkaarTypeSkjema">
                        <div class="mb-3">
                            <label for="nyVilkaarNavn" class="form-label">Vilkårsnavn (label):</label>
                            <input type="text" class="form-control" id="nyVilkaarNavn" required>
                            <div class="error-message" id="nyVilkaarNavnError"></div>
                        </div>
                        <div class="mb-3">
                            <label for="nyVilkaarTemplate" class="form-label">Vilkårsråtekst (template med Markdown):</label>
                            <textarea class="form-control" id="nyVilkaarTemplate" rows="5" required></textarea>
                            <div class="error-message" id="nyVilkaarTemplateError"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-info" id="aapneRetningslinjeModalKnappNyType">Retningslinje for maler</button>
                    <div>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Avbryt</button>
                        <button type="button" id="lagreNyVilkaarTypeKnapp" class="btn btn-primary">Legg til</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="retningslinjeModal" tabindex="-1" aria-labelledby="retningslinjeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl"> 
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="retningslinjeModalLabel">Retningslinje for å Lage Nye Vilkårstyper</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Lukk"></button>
                </div>
                <div class="modal-body" id="retningslinjeInnhold">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Lukk</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- DATAMODELLER (med < > placeholders) ---
        let vilkaarstyper = [ 
            { id: "konsesjonsavgifter", label: "Konsesjonsavgifter", template: "Det skal betales en **årlig avgift** til staten på <beløp valuta='kr'> pr. nat.hk og de kommuner og fylkeskommuner som Kongen bestemmer på <beløp valuta='kr'> pr. nat.hk.\n\nSatsene refererer seg til det som opprinnelig ble fastsatt ved kgl.res. av <dato format='dd.mm.åååå'>."},
            { id: "minstevannforing", label: "Minstevannsføring inntak", template: "Det skal for kraftanlegg <anlegg type='vannkraft'> slippes en <vannføring type='minstevannføring' metrikk='l/s'> hele året."},
            { id: "maksimalhoyde", label: "Utforming, maksimal høyde", template: "Maksimal høyde på vindkraftsanlegg <anlegg type='vindkraft'> er <høyde type='maksimal høyde over bakken' metrikk='meter over bakken'>."},
            { id: "byggefrister", label: "Byggefrister", template: "Arbeidet med det konsesjonsgitte tiltaket må påbegynnes innen <frist metrikk='år' min=1 max=10> fra konsesjonen ble gitt og fullføres innen ytterligere <frist metrikk='år' min=1 max=10>.\n\n**Fristforlengelse:**\nFristene kan forlenges av NVE.\n\n*Merk: I fristene medregnes ikke den tid som pga. force majeure har vært umulig å utnytte.*"},
            { id: "tabell_eksempel", label: "Tabell Eksempel", template: "# Prisliste\n\nHer er en oversikt over kostnader:\n\n|| Tjeneste || Pris || Enhet ||\n| Standardpakke | <beløp valuta='kr'> | per år |\n| Utvidet support | <beløp valuta='kr'> | per mnd |\n\nAlle priser er eks. mva."},
            { id: "endring", label: "Endring av konsesjon", template: "NVE kan fastsette nye vilkår for anlegget dersom det foreligger *sterke* samfunnsmessige interesser."},
			{ id: "tappevann", label: "Tappe vann", template: "<anlegg type='vannkraft'> gis løyve til å tappe inntil <slukeevne metrikk='l/s' type='sommer'> i sommerhalvåret og <slukeevne metrikk='l/s' type='vinter'> i vinterhalvåret fra elva <elv>."},
            { 
                id: "regulering_vannstand_ny", 
                label: "Regulering av vannstand (m/ tabell)", 
                template: "Konsesjonær er **pliktig** til å *regulere* vannstanden i <innsjø> som følger:\n|| Årstid || Høyeste regulerte vannstand (HRV) || Laveste regulerte vannstand (LRV) ||\n| **Sommer (15.05–15.09)** | <vannstand metrikk='moh' type='høyeste'> | <vannstand metrikk='moh' type='laveste'> |\n| **Vinter (16.09–14.05)** | <vannstand metrikk='moh' type='høyeste_vinter'> | <vannstand metrikk='moh' type='laveste_vinter'> |\n\n**Bøtesats: <beløp valuta='kr'> per dag.**"
            },
			{ id: "detaljplan", label: "Detaljplan", template: "Detaljplan utarbeides av <aktør> og godkjennes av NVE. Planen skal følge NVEs veileder."},
            { id: "tilbakekallelse", label: "Tilbakekallelse av konsesjon", template: "Konsesjonen kan trekkes tilbake dersom konsesjonæren tas under konkursbehandling, …"}
        ];
        // ... (fiktiveAnlegg, fiktiveElver, fiktiveInnsjoer, aktørerData, kjenteTagTyper, dataKilder som før) ...
        const fiktiveAnlegg = [
          { id: 9601,  navn: "Nye Aunfoss kraftverk", type: "vannkraft" }, { id: 9600, navn: "Nye Tunnsjødal kraftverk", type: "vannkraft" },
          { id: 8804, navn: "Langerud koblingsstasjon og kaianlegg", type: "kraftledning" }, { id: 284, navn: "Råholt – Fjernvarmeanlegg", type: "fjernvarme" },
          { id: 19322, navn: "Omlegging 66 kV mellom Verdal S – Ørin", type: "kraftledning" }, { id: 12975, navn: "132 kV Bevergrenda – Stengelsrud – Glabak", type: "kraftledning" },
          { id: 9146,  navn: "Oterholtfoss kraftverk", type: "vannkraft" }, { id: 20446, navn: "Nøkleby solkraftverk", type: "solkraft" },
		  { id: 20447, navn: "Oslo sentrum solkraftverk", type: "solkraft" }, { id: 18246, navn: "Strømforsyning Fossvatn og Seltuftvatn", type: "kraftledning" },
          { id: 9364,  navn: "Nedlegging av Sævik dam", type: "dam" }, { id: 3655, navn: "Grunnvannsuttak i Mølmannsdalen", type: "vannuttak" },
          { id: 20411, navn: "Slettefjellet solkraftverk", type: "solkraft" }, { id: 19376, navn: "Hensåsen solkraftverk", type: "solkraft" },
          { id: 20500, navn: "Toppåsen Vindkraftpark", type: "vindkraft" }, { id: 20501, navn: "Indredal vifter og strøm", type: "vindkraft" }
        ];
        const fiktiveElver = [
            { id: 1, navn: "Glomma" }, { id: 2, navn: "Pasvikelva og Ivalojoki" }, { id: 3, navn: "Numedalslågen" }, 
            { id: 4, navn: "Gudbrandsdalslågen og Vorma" }, { id: 5, navn: "Tana" }, { id: 6, navn: "Drammensvassdraget" },
            { id: 7, navn: "Skiensvassdraget" }, { id: 8, navn: "Otra" }, { id: 9, navn: "Altaelva" }, 
            { id: 10, navn: "Trysilelva og Klarälven" }, { id: 11, navn: "Namsen" }, { id: 12, navn: "Hallingdalselva og Snarumselva" },
            { id: 13, navn: "Arendalsvassdraget" }, { id: 14, navn: "Orkla" }, { id: 15, navn: "Rena" }, 
            { id: 16, navn: "Vefsna" }, { id: 17, navn: "Nea-Nidelvvassdraget" }, { id: 18, navn: "Gaula" },
            { id: 19, navn: "Målselva" }, { id: 20, navn: "Karasjohka" }
        ];
        const fiktiveInnsjoer = [ 
            { id: 101, navn: "Mjøsa" }, { id: 102, navn: "Røssvatnet" }, { id: 103, navn: "Femunden" }, 
            { id: 104, navn: "Randsfjorden" }, { id: 105, navn: "Tyrifjorden" }, { id: 106, navn: "Snåsavatnet" },
            { id: 107, navn: "Tunnsjøen" }, { id: 108, navn: "Limingen" }, { id: 109, navn: "Øyeren" }, 
            { id: 110, navn: "Blåsjø" }, { id: 111, navn: "Altevatnet" }, { id: 112, navn: "Nisser" },
            { id: 113, navn: "Siiddašjávri / Sijdasjavre" }, { id: 114, navn: "Selbusjøen" }, { id: 115, navn: "Storsjøen (i Rendalen)" }, 
            { id: 116, navn: "Krøderen" }, { id: 117, navn: "Sperillen" }, { id: 118, navn: "Lundevatnet" },
            { id: 119, navn: "Storglomvatnet" }, { id: 120, navn: "Aursunden" }
        ];
        const aktørerData = [{id: "Konsesjonær", navn: "Konsesjonær"}, {id: "Tiltakshaver", navn: "Tiltakshaver"}];
        const kjenteTagTyper = {
            "anlegg": { kategori: "entitet", uiType: "dropdown", dataSourceName: "fiktiveAnlegg", idAttr: "id", navnAttr: "navn" },
            "aktør":  { kategori: "entitet", uiType: "dropdown", dataSourceName: "aktørerData", idAttr: "id", navnAttr: "navn" },
            "elv":    { kategori: "entitet", uiType: "dropdown", dataSourceName: "fiktiveElver", idAttr: "id", navnAttr: "navn" },
            "innsjø": { kategori: "entitet", uiType: "dropdown", dataSourceName: "fiktiveInnsjoer", idAttr: "id", navnAttr: "navn" },
            "dam":    { kategori: "entitet", uiType: "dropdown", dataSourceName: "fiktiveInnsjoer", idAttr: "id", navnAttr: "navn" }, 
            "beløp":      { kategori: "parameter", uiType: "numberInput", standardMetrikkAttr: "valuta" },
            "dato":       { kategori: "parameter", uiType: "datePicker", standardFormatAttr: "format" },
            "frist":      { kategori: "parameter", uiType: "numberInput", standardMetrikkAttr: "metrikk" },
            "vannføring": { kategori: "parameter", uiType: "numberInput", standardMetrikkAttr: "metrikk" },
            "vannstand":  { kategori: "parameter", uiType: "numberInput", standardMetrikkAttr: "metrikk" },
            "slukeevne":  { kategori: "parameter", uiType: "numberInput", standardMetrikkAttr: "metrikk" },
            "høyde":      { kategori: "parameter", uiType: "numberInput", standardMetrikkAttr: "metrikk" },
            "tekstfelt":  { kategori: "parameter", uiType: "textInput" }
        };
        const dataKilder = { fiktiveAnlegg, fiktiveElver, fiktiveInnsjoer, aktørerData };


        let currentTemplateString = '';
        let currentPlaceholdersData = []; 
        let currentSelectedVilkårType = null;
        let nextVilkårInstanceId = 0;
        let nesteEgendefinertId = 10000; 
        let vilkaarModalInstance = null;
        let nyVilkaarTypeModalInstance = null;
        let retningslinjeModalInstance = null;
        let activeTooltips = [];

        function escapeHtmlMinimal(unsafe) {
            if (typeof unsafe !== 'string') return unsafe;
            return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }
        function unescapeHtmlEntities(escapedHtml) {
            if (typeof escapedHtml !== 'string') return escapedHtml;
            try {
                const doc = new DOMParser().parseFromString(escapedHtml, 'text/html');
                return doc.documentElement.textContent;
            } catch (e) {
                const textarea = document.createElement('textarea');
                textarea.innerHTML = escapedHtml;
                return textarea.value;
            }
        }
        function escapeRegExp(string) { return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
        
        function formatCurrency(number, currencySymbol) {
            if (number === null || number === undefined || String(number).trim() === '') return '';
            const num = parseFloat(String(number).replace(/\s/g, '')); 
            if (isNaN(num)) return String(number); 
            let numStr = String(num.toFixed(0));
            let formattedNum = "";
            let counter = 0;
            for (let i = numStr.length - 1; i >= 0; i--) {
                if (counter > 0 && counter % 3 === 0) formattedNum = " " + formattedNum;
                formattedNum = numStr[i] + formattedNum;
                counter++;
            }
            return `${currencySymbol} ${formattedNum},-`;
        }

        function convertMarkdownToHtml(md) {
            if (typeof md !== 'string') return '';
            let html = md;

            html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
            html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');

            let inTable = false;
            html = html.split('\n').map(line => {
                const trimmedLine = line.trim();
                if (trimmedLine.startsWith('||') && trimmedLine.endsWith('||')) {
                    const headers = trimmedLine.slice(2, -2).split('||').map(h => {
                        const headerContent = h.trim();
                        return `<th>${headerContent.startsWith('<span') ? headerContent : escapeHtmlMinimal(headerContent)}</th>`;
                    }).join('');
                    let tableStart = '';
                    if (!inTable) {
                        tableStart = '<table>';
                        inTable = true;
                    } else { 
                        tableStart = '</tbody></table><table>';
                    }
                    return `${tableStart}<thead><tr>${headers}</tr></thead><tbody>`;
                } else if (trimmedLine.startsWith('|') && trimmedLine.endsWith('|') && inTable) {
                    const cells = trimmedLine.slice(1, -1).split('|').map(c => {
                        const cellContent = c.trim();
                        return `<td>${cellContent.startsWith('<span') ? cellContent : escapeHtmlMinimal(cellContent)}</td>`;
                    }).join('');
                    return `<tr>${cells}</tr>`;
                } else {
                    let prefix = '';
                    if (inTable && trimmedLine !== '') { 
                        prefix = '</tbody></table>';
                        inTable = false;
                    }
                    return prefix + line; 
                }
            }).join('\n');
            if (inTable) html += '</tbody></table>';

            html = html.replace(/ {2,}\n/g, '<br>\n');
            html = html.replace(/^((\s*[-*+] (.*)(\n|$))+)/gim, (match) => {
                const items = match.split('\n').filter(item => item.trim() !== '').map(item => `<li>${escapeHtmlMinimal(item.trim().substring(2))}</li>`).join('');
                return `<ul>${items}</ul>`;
            });
             html = html.replace(/^((\s*\d+\. (.*)(\n|$))+)/gim, (match) => {
                const items = match.split('\n').filter(item => item.trim() !== '').map(item => `<li>${escapeHtmlMinimal(item.trim().substring(item.indexOf('.') + 1).trim())}</li>`).join('');
                return `<ol>${items}</ol>`;
            });
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/__(.*?)__/g, '<strong>$1</strong>');
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/_(.*?)_/g, '<em>$1</em>');
            
            html = html.replace(/\n{2,}/g, '</p><p>'); 
            html = `<p>${html}</p>`; 
            html = html.replace(/<p>\s*<\/p>/gi, ''); 
            html = html.replace(/<p>(<(h[1-6]|ul|ol|table|blockquote|pre|hr)>)/gi, '$1'); 
            html = html.replace(/(<\/(h[1-6]|ul|ol|table|blockquote|pre|hr)>)<\/p>/gi, '$1');
            html = html.replace(/<p><br\s*\/?>\s*<\/p>/gi, '<br>'); 

            return html;
        }

        function parseRawPlaceholders(template) {
            const placeholders = [];
            const placeholderRegex = /<([^>\s]+)\s*([^>]*)>/g; 
            const attributeRegex = /([a-zA-Z0-9_æøåÆØÅ]+)\s*=\s*(?:'([^']*)'|"([^"]*)"|([^>\s]+))/g;
            let match;
            let placeholderIndex = 0;
            while ((match = placeholderRegex.exec(template)) !== null) {
                const raw = match[0];
                const tagName = match[1]; 
                const attributesString = match[2].trim();
                const attributes = {};
                let attrMatch;
                while((attrMatch = attributeRegex.exec(attributesString)) !== null) {
                    attributes[attrMatch[1]] = unescapeHtmlEntities(attrMatch[2] || attrMatch[3] || attrMatch[4] || '');
                }
                
                const kjentTypeInfo = kjenteTagTyper[tagName];
                if (kjentTypeInfo && kjentTypeInfo.kategori === 'entitet') {
                    if (!attributes.hasOwnProperty('navn')) attributes.navn = ''; 
                    if (kjentTypeInfo.idAttr && !attributes.hasOwnProperty(kjentTypeInfo.idAttr)) {
                         attributes[kjentTypeInfo.idAttr] = '';
                    }
                } 
                else if (!attributes.hasOwnProperty('verdi')) { // For alle andre (parameter eller ukjent)
                     attributes.verdi = ''; // Anta at 'verdi' trengs hvis ikke spesifisert
                }
                placeholders.push({ raw, tagName, attributes, originalIndex: placeholderIndex++ });
            }
            return placeholders;
        }
        
        function displayRawTemplatePreview() {
            const selectedTypeId = document.getElementById('vilkaarTypeSelect').value;
            const selectedType = vilkaarstyper.find(type => type.id === selectedTypeId);
            const previewDiv = document.getElementById('rawTemplatePreviewSelect');
            if (selectedType) {
                previewDiv.textContent = selectedType.template;
            } else { previewDiv.innerHTML = ''; }
        }

        function populateVilkaarTypeSelect(selectLast = false) {
            const selectElement = document.getElementById('vilkaarTypeSelect');
            const currentValue = selectElement.value; 
            selectElement.innerHTML = ''; 
            vilkaarstyper.forEach(type => {
                const option = document.createElement('option');
                option.value = type.id; option.textContent = type.label;
                selectElement.appendChild(option);
            });
            selectElement.removeEventListener('change', displayRawTemplatePreview); 
            selectElement.addEventListener('change', displayRawTemplatePreview);
            if (selectLast && vilkaarstyper.length > 0) selectElement.value = vilkaarstyper[vilkaarstyper.length - 1].id;
            else if (vilkaarstyper.find(vt => vt.id === currentValue)) selectElement.value = currentValue;
            else if (vilkaarstyper.length > 0) selectElement.value = vilkaarstyper[0].id; 
            displayRawTemplatePreview(); 
        }

        function createFormFieldUI(placeholderData, placeholderOriginalIndex) {
            const { tagName, attributes } = placeholderData;
            let kjentTypeInfo = kjenteTagTyper[tagName] || { kategori: "parameter", uiType: "textInput" }; 
            
            if (attributes.hasOwnProperty('valg') && kjentTypeInfo.kategori === 'parameter') {
                kjentTypeInfo = { ...kjentTypeInfo, uiType: 'customDropdown' }; 
            }

            const formGroup = document.createElement('div');
            formGroup.className = 'mb-3';
            const labelEl = document.createElement('label');
            labelEl.className = 'form-label';
            let labelText = tagName.charAt(0).toUpperCase() + tagName.slice(1);
            const fieldBaseId = `ph-${placeholderOriginalIndex}`; 
            
            labelEl.htmlFor = `${fieldBaseId}-${kjentTypeInfo.kategori === 'entitet' || kjentTypeInfo.uiType === 'customDropdown' ? 'dropdown' : 'verdi'}`;

            if (kjentTypeInfo.kategori === 'entitet') {
                const typeAttr = attributes.type;
                labelText += typeAttr && tagName === 'anlegg' ? ` (Type: ${typeAttr})` : '';
            } else { 
                const typeAttr = attributes.type; 
                if(typeAttr) labelText += ` (Type: ${typeAttr})`;
                const metrikk = attributes.metrikk || attributes.valuta;
                if (metrikk) labelText += ` [${metrikk}]`;
                if (attributes.format) labelText += ` (${attributes.format})`;
            }
            labelEl.textContent = labelText + ':';
            formGroup.appendChild(labelEl);

            let inputElement;
            if (kjentTypeInfo.uiType === 'dropdown') {
                inputElement = document.createElement('select');
                inputElement.className = 'form-select';
                inputElement.id = `${fieldBaseId}-dropdown`;
                inputElement.dataset.tagName = tagName; 

                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = `Velg ${tagName.toLowerCase()}...`;
                inputElement.appendChild(defaultOption);

                const dataSource = dataKilder[kjentTypeInfo.dataSourceName] || [];
                let filteredSource = dataSource;
                if (tagName === 'anlegg' && attributes.type) {
                    filteredSource = dataSource.filter(item => item.type === attributes.type);
                }

                filteredSource.forEach(item => {
                    const option = document.createElement('option');
                    option.value = String(item[kjentTypeInfo.idAttr] || item[kjentTypeInfo.navnAttr]); 
                    option.textContent = unescapeHtmlEntities(item.navn);
                    if ((attributes.id && String(attributes.id) === option.value) || 
                        (!attributes.id && attributes.navn === item.navn && (tagName === 'elv' || tagName === 'innsjø' || tagName === 'dam' || tagName === 'aktør') ) ) { 
                        option.selected = true;
                    } else if (attributes.navn === item.navn && (tagName === 'anlegg' || tagName === 'aktør') && attributes.id === ''){ 
                        option.selected = true;
                    }
                    inputElement.appendChild(option);
                });
            } else if (kjentTypeInfo.uiType === 'customDropdown') { 
                inputElement = document.createElement('select');
                inputElement.className = 'form-select';
                inputElement.id = `${fieldBaseId}-dropdown`;
                inputElement.dataset.tagName = tagName;
                inputElement.dataset.attributeName = 'verdi';

                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = `Velg ${attributes.label || tagName.toLowerCase()}...`; 
                inputElement.appendChild(defaultOption);

                const valgOptions = attributes.valg.split('|');
                valgOptions.forEach(valg => {
                    const option = document.createElement('option');
                    const trimmedValg = valg.trim();
                    option.value = trimmedValg;
                    option.textContent = trimmedValg;
                    if (attributes.verdi === trimmedValg) {
                        option.selected = true;
                    }
                    inputElement.appendChild(option);
                });

            } else { 
                inputElement = document.createElement('input');
                inputElement.className = 'form-control';
                inputElement.id = `${fieldBaseId}-verdi`;
                inputElement.dataset.attributeName = 'verdi'; 
                
                if (kjentTypeInfo.uiType === 'numberInput' || attributes.hasOwnProperty('min') || attributes.hasOwnProperty('max')) {
                    inputElement.type = 'number'; 
                } else if (kjentTypeInfo.uiType === 'datePicker' || tagName === 'dato') { 
                    inputElement.type = 'text';
                    inputElement.placeholder = attributes.format || 'dd.mm.åååå';
                } else {
                    inputElement.type = 'text';
                }

                if (attributes.min !== undefined) inputElement.min = attributes.min;
                if (attributes.max !== undefined) inputElement.max = attributes.max;
                
                const initialValue = attributes.verdi;
                inputElement.value = (initialValue === '0' && inputElement.type === 'number' && !attributes.min) ? '' : unescapeHtmlEntities(initialValue || '');
            }
            
            inputElement.dataset.placeholderOriginalIndex = placeholderOriginalIndex; 
            inputElement.addEventListener('input', handleFormInputChange);
            formGroup.appendChild(inputElement);

            const errorSpan = document.createElement('span');
            errorSpan.className = 'error-message';
            errorSpan.id = `error-${inputElement.id}`; 
            formGroup.appendChild(errorSpan);
            
            return formGroup;
        }

        function renderModalForm() {
            const form = document.getElementById('vilkaarSkjema');
            form.innerHTML = '';
            currentPlaceholdersData.forEach((phData) => {
                const kjentTypeInfo = kjenteTagTyper[phData.tagName];
                let needsInput = false;

                if (kjentTypeInfo && kjentTypeInfo.kategori === 'entitet') {
                    if (!phData.attributes.navn || (kjentTypeInfo.idAttr && !phData.attributes.id)) {
                        needsInput = true;
                    }
                } else { 
                    if (phData.attributes.valg || !phData.attributes.hasOwnProperty('verdi') || phData.attributes.verdi === '') {
                        needsInput = true;
                    }
                }
                
                if(needsInput){
                    form.appendChild(createFormFieldUI(phData, phData.originalIndex));
                }
            });
            updateLivePreview(); 
            validateModalForm(); 
        }
        
        function handleFormInputChange(event) {
            const inputElement = event.target;
            const placeholderOriginalIndex = parseInt(inputElement.dataset.placeholderOriginalIndex);
            const placeholderToUpdate = currentPlaceholdersData.find(p => p.originalIndex === placeholderOriginalIndex);
            if (!placeholderToUpdate) return;

            if (inputElement.tagName === 'SELECT') { 
                const selectedValue = inputElement.value;
                const tagNameFromDataset = inputElement.dataset.tagName; 
                const kjentTypeInfo = kjenteTagTyper[tagNameFromDataset];
                
                if (kjentTypeInfo && kjentTypeInfo.kategori === 'entitet') {
                    const dataSource = dataKilder[kjentTypeInfo.dataSourceName] || [];
                    if (selectedValue) {
                        const selectedItem = dataSource.find(item => String(item[kjentTypeInfo.idAttr]) === selectedValue);
                        if (selectedItem) {
                            placeholderToUpdate.attributes.navn = selectedItem.navn;
                            if (kjentTypeInfo.idAttr) placeholderToUpdate.attributes.id = selectedItem.id;
                        }
                    } else { 
                        placeholderToUpdate.attributes.navn = '';
                        if (kjentTypeInfo.idAttr) placeholderToUpdate.attributes.id = '';
                    }
                } else { 
                     placeholderToUpdate.attributes.verdi = selectedValue;
                }
            } else { 
                const attributeName = inputElement.dataset.attributeName || 'verdi'; 
                placeholderToUpdate.attributes[attributeName] = inputElement.value; 
            }
            updateLivePreview();
            validateModalForm();
        }

        function validateModalForm() {
            let allValid = true;
            const lagreKnapp = document.getElementById('lagreVilkårKnapp');
            document.querySelectorAll('#vilkaarSkjema .error-message').forEach(span => span.textContent = '');
            const formElements = document.querySelectorAll('#vilkaarSkjema .form-control, #vilkaarSkjema .form-select');
            
            if (formElements.length === 0) { 
                lagreKnapp.disabled = false;
                return true;
            }

            formElements.forEach(inputElement => {
                const placeholderOriginalIndex = parseInt(inputElement.dataset.placeholderOriginalIndex);
                const placeholderData = currentPlaceholdersData.find(p => p.originalIndex === placeholderOriginalIndex);
                if (!placeholderData) return;

                let isValidField = true; 
                let errorMessage = '';

                if (inputElement.tagName === 'SELECT') { 
                    if (!inputElement.value) { 
                        isValidField = false; 
                        errorMessage = `Vennligst gjør et valg for '${placeholderData.tagName}'.`; 
                    }
                } else { 
                    const currentValue = inputElement.value;
                    const origPhForValidation = parseRawPlaceholders(placeholderData.raw)[0]; 
                    const initialValueInTemplate = origPhForValidation.attributes[inputElement.dataset.attributeName || 'verdi'];

                    const isRequired = !placeholderData.attributes.hasOwnProperty('verdi') || initialValueInTemplate === '' || initialValueInTemplate === '0';
                    
                    if (isRequired && currentValue.trim() === '') { isValidField = false; errorMessage = 'Feltet er påkrevd.'; }
                    else if (inputElement.type === 'number' && currentValue.trim() !== '') {
                        const numVal = parseFloat(currentValue);
                        if (isNaN(numVal)) { isValidField = false; errorMessage = 'Ugyldig tallformat.'; }
                        else {
                            const minIsSet = inputElement.min !== "" && inputElement.min !== null;
                            const minVal = minIsSet ? parseFloat(inputElement.min) : null;

                            if (!minIsSet && numVal <= 0 && initialValueInTemplate === '0') {
                                isValidField = false; errorMessage = 'Verdien må være større enn 0.';
                            } else if (minIsSet && numVal < minVal) {
                                isValidField = false; errorMessage = `Verdien må være minst ${minVal}.`;
                            }
                            
                            const maxAttr = inputElement.max;
                            if (maxAttr !== "" && maxAttr !== null && numVal > parseFloat(maxAttr)) { isValidField = false; errorMessage = `Verdien må være maks ${maxAttr}.`; }
                        }
                    } else if ((placeholderData.tagName === 'dato' || (placeholderData.attributes && placeholderData.attributes.format === 'dd.mm.åååå')) && inputElement.type === 'text') {
                         if (currentValue.trim() !== '' && !/^\d{2}\.\d{2}\.\d{4}$/.test(currentValue)) {
                            isValidField = false; errorMessage = 'Ugyldig datoformat (bruk dd.mm.åååå).';
                        }
                    }
                }
                if (!isValidField) {
                    document.getElementById(`error-${inputElement.id}`).textContent = errorMessage;
                    allValid = false;
                }
            });
            lagreKnapp.disabled = !allValid;
            return allValid;
        }
        
        function generateTextFromTemplate(templateString, filledPlaceholders, readable, withColor = false, forModalPreview = false) {
            let segments = []; 
            let lastIndex = 0;
            const sortedPlaceholders = [...filledPlaceholders].sort((a, b) => a.originalIndex - b.originalIndex);

            sortedPlaceholders.forEach(livePhData => {
                const origPhStruct = livePhData; 
                const searchArea = templateString.substring(lastIndex);
                const match = searchArea.match(new RegExp(escapeRegExp(origPhStruct.raw)));

                if (!match) { return;  }
                
                const phStartIndexInSegment = match.index;
                const phActualStartIndex = lastIndex + phStartIndexInSegment;
                
                segments.push(readable ? templateString.substring(lastIndex, phActualStartIndex) : escapeHtmlMinimal(templateString.substring(lastIndex, phActualStartIndex)));
                
                let replacementContent = '';
                const kjentTypeInfo = kjenteTagTyper[livePhData.tagName];

                if (readable) {
                    let displayValue = ''; 
                    let isFilledValue = false; 
                    const phValue = livePhData.attributes.verdi;
                    const phNavn = livePhData.attributes.navn;
                    const phMetrikk = livePhData.attributes.metrikk || (origPhStruct.attributes && origPhStruct.attributes.metrikk);
                    const phValuta = livePhData.attributes.valuta || (origPhStruct.attributes && origPhStruct.attributes.valuta);
                    
                    let awaitsUserInput = false;
                    if (kjentTypeInfo && kjentTypeInfo.kategori === 'entitet') {
                        awaitsUserInput = !phNavn || phNavn.trim() === '';
                    } else { 
                        awaitsUserInput = (phValue === undefined || String(phValue).trim() === '' || 
                                          (phValue === '0' && origPhStruct.attributes.verdi === '0' && !livePhData.attributes.valg && !phValuta));
                        if(livePhData.attributes.valg && !phValue) awaitsUserInput = true; 
                    }

                    if (awaitsUserInput && forModalPreview) { 
                        let missingText = `?${livePhData.tagName}?`;
                        if (kjentTypeInfo && kjentTypeInfo.kategori === 'parameter') { 
                             if (phMetrikk) missingText += ` [${phMetrikk}]`; 
                             else if (phValuta) missingText += ` (${phValuta})`;
                        }
                        replacementContent = `<span class="placeholder-missing-value">${escapeHtmlMinimal(missingText)}</span>`;
                    
                    } else if (kjentTypeInfo && kjentTypeInfo.kategori === 'entitet') {
                        displayValue = phNavn || `[${livePhData.tagName} ikke valgt]`;
                        if (phNavn && phNavn.trim() !== '') isFilledValue = true;
                        replacementContent = escapeHtmlMinimal(unescapeHtmlEntities(displayValue));
                    } else { 
                        if (phValue !== undefined && String(phValue).trim() !== '') { 
                            isFilledValue = true;
                            if (phValuta) {
                                displayValue = formatCurrency(phValue, phValuta);
                            } else {
                                displayValue = phValue;
                                if (phMetrikk) { 
                                    displayValue += ` ${phMetrikk}`;
                                }
                            }
                        } else if (phValue === '' && phValue !== undefined && !forModalPreview) { 
                             displayValue = ''; 
                             if (phMetrikk) displayValue = ` ${phMetrikk}`; 
                             else if (phValuta) displayValue = ` ${phValuta} 0,-`;
                             isFilledValue = true; 
                        }
                        else if (phNavn !== undefined && String(phNavn).trim() !== '') { 
                            displayValue = phNavn;
                            isFilledValue = true; 
                        } 
                        else if (awaitsUserInput && !forModalPreview) { 
                             displayValue = `[${livePhData.tagName} mangler verdi]`;
                        }
                        else {
                             displayValue = `[${livePhData.tagName}]`; 
                        }
                        replacementContent = escapeHtmlMinimal(unescapeHtmlEntities(displayValue)); 
                    }
                    
                    if (withColor && isFilledValue && !replacementContent.includes('placeholder-missing-value') && String(replacementContent).trim() !== '' && !replacementContent.startsWith('[') && !replacementContent.startsWith('?')) {
                        replacementContent = `<span class="user-value">${replacementContent}</span>`;
                    }
                } else { 
                    let newTag = `<${livePhData.tagName}`;
                    for (const attrKey in livePhData.attributes) {
                        if (livePhData.attributes.hasOwnProperty(attrKey) && livePhData.attributes[attrKey] !== undefined) {
                            const attrValue = livePhData.attributes[attrKey];
                            const escapedForAttr = String(attrValue).replace(/&/g, '&amp;').replace(/'/g, '&#039;'); 
                            newTag += ` ${attrKey}='${escapedForAttr}'`;
                        }
                    }
                    newTag += '>';
                    replacementContent = escapeHtmlMinimal(newTag); 
                }
                segments.push(replacementContent);
                lastIndex = phActualStartIndex + origPhStruct.raw.length;
            });
            if (readable) {
                segments.push(templateString.substring(lastIndex));
            } else {
                 segments.push(escapeHtmlMinimal(templateString.substring(lastIndex)));
            }
            
            let joinedSegments = segments.join('');
            if(readable) {
                return convertMarkdownToHtml(joinedSegments);
            }
            return joinedSegments;
        }
        
        function updateLivePreview() { 
             const livePreviewDiv = document.getElementById('livePreview');
            if (livePreviewDiv) {
                livePreviewDiv.innerHTML = generateTextFromTemplate(currentTemplateString, currentPlaceholdersData, true, true, true);
            }
            const rawPreviewDiv = document.getElementById('rawPreview');
            if (rawPreviewDiv) {
                let rawOutput = currentTemplateString;
                const sortedPlaceholders = [...currentPlaceholdersData].sort((a,b) => b.raw.length - a.raw.length); 

                sortedPlaceholders.forEach(ph => {
                    let newTag = `<${ph.tagName}`;
                     for (const attrKey in ph.attributes) {
                        if (ph.attributes.hasOwnProperty(attrKey) && ph.attributes[attrKey] !== undefined) {
                            let val = ph.attributes[attrKey];
                            newTag += ` ${attrKey}='${escapeHtmlMinimal(String(val))}'`;
                        }
                    }
                    newTag += '>';
                    rawOutput = rawOutput.split(ph.raw).join(newTag);
                });
                rawPreviewDiv.textContent = rawOutput;
            }
        }
        
        document.getElementById('leggTilVilkårKnapp').addEventListener('click', () => {
            const selectedTypeId = document.getElementById('vilkaarTypeSelect').value;
            const selectedType = vilkaarstyper.find(type => type.id === selectedTypeId);
            if (!selectedType) { alert("Vennligst velg en vilkårstype."); return; }

            currentTemplateString = selectedType.template;
            const initialPlaceholders = parseRawPlaceholders(currentTemplateString); 
            
            let requiresModal = initialPlaceholders.some(ph => {
                const kjentType = kjenteTagTyper[ph.tagName];
                if (kjentType && kjentType.kategori === 'entitet') {
                    return ph.attributes.navn === ''; 
                }
                return ph.attributes.valg || ph.attributes.verdi === '';
            });

            if (initialPlaceholders.length === 0) requiresModal = false;

            if (!requiresModal) { 
                const listItemId = `vilkaar-item-${nextVilkårInstanceId++}`;
                const listItem = document.createElement('div');
                listItem.className = 'list-group-item mb-3 p-3 shadow-sm';
                listItem.id = listItemId;
                const readableHtml = generateTextFromTemplate(currentTemplateString, initialPlaceholders, true, true, false); 

                listItem.innerHTML = `
                    <div class="vilkaar-item-header">
                        <h5 class="mb-1">${escapeHtmlMinimal(selectedType.label)}</h5>
                        <button type="button" class="btn-close delete-vilkaar-btn" aria-label="Slett"></button>
                    </div>
                    <div class="readable-template-display"></div> 
                `;
                listItem.querySelector('.readable-template-display').innerHTML = readableHtml;

                const rawTextForTooltip = generateTextFromTemplate(currentTemplateString, initialPlaceholders, false);
                listItem.dataset.bsToggle = "tooltip";
                listItem.dataset.bsPlacement = "left";
                listItem.dataset.bsTitle = `<div style='text-align:left;'><strong>Råtekst:</strong><br>${rawTextForTooltip}</div>`;


                listItem.querySelector('.delete-vilkaar-btn').addEventListener('click', () => {
                    const tooltipInstance = bootstrap.Tooltip.getInstance(listItem); 
                    if (tooltipInstance) tooltipInstance.dispose();
                    listItem.remove();
                    activeTooltips = activeTooltips.filter(t => t._element !== listItem);
                });
                document.getElementById('vilkaarListe').appendChild(listItem);
                if(initialPlaceholders.length > 0 && initialPlaceholders.some(ph => Object.keys(ph.attributes).length > 0 && (ph.attributes.navn || ph.attributes.hasOwnProperty('verdi')))) initTooltips();
            } else { 
                currentPlaceholdersData = JSON.parse(JSON.stringify(initialPlaceholders)); 
                currentSelectedVilkårType = selectedType;
                document.getElementById('vilkaarModalLabel').textContent = `Fyll ut: ${selectedType.label}`;
                renderModalForm();
                if (!vilkaarModalInstance) vilkaarModalInstance = new bootstrap.Modal(document.getElementById('vilkaarModal'));
                vilkaarModalInstance.show();
            }
        });

        document.getElementById('lagreVilkårKnapp').addEventListener('click', () => {
             if (!validateModalForm() || !currentSelectedVilkårType) return;
            const listItemId = `vilkaar-item-${nextVilkårInstanceId++}`;
            const listItem = document.createElement('div');
            listItem.className = 'list-group-item mb-3 p-3 shadow-sm';
            listItem.id = listItemId;

            const readableHtmlForDisplay = generateTextFromTemplate(currentTemplateString, currentPlaceholdersData, true, true, false); 
            const logicalRawString = generateTextFromTemplate(currentTemplateString, currentPlaceholdersData, false);
            const rawTextForTooltip = logicalRawString; 

            listItem.innerHTML = `
                <div class="vilkaar-item-header">
                    <h5 class="mb-1">${escapeHtmlMinimal(currentSelectedVilkårType.label)}</h5>
                    <button type="button" class="btn-close delete-vilkaar-btn" aria-label="Slett"></button>
                </div>
                <div class="readable-template-display"></div> 
            `;
            listItem.querySelector('.readable-template-display').innerHTML = readableHtmlForDisplay; 

            listItem.dataset.bsToggle = "tooltip";
            listItem.dataset.bsPlacement = "left";
            listItem.dataset.bsTitle = `<div style='text-align:left;'><strong>Råtekst:</strong><br>${rawTextForTooltip}</div>`;

            listItem.querySelector('.delete-vilkaar-btn').addEventListener('click', () => {
                const tooltipInstance = bootstrap.Tooltip.getInstance(listItem);
                if (tooltipInstance) tooltipInstance.dispose();
                listItem.remove();
                activeTooltips = activeTooltips.filter(t => t._element !== listItem);
            });
            document.getElementById('vilkaarListe').appendChild(listItem);
            initTooltips(); 
            
            const modalSkjemaVar = currentSelectedVilkårType; 
            currentSelectedVilkårType = null; 
            if (modalSkjemaVar) vilkaarModalInstance.hide(); 
        });
        
        document.getElementById('vilkaarModal').addEventListener('hidden.bs.modal', function () {
            if (currentSelectedVilkårType) { 
                currentTemplateString = ''; 
                currentPlaceholdersData = []; 
                currentSelectedVilkårType = null;
                document.getElementById('vilkaarSkjema').innerHTML = '';
                document.getElementById('livePreview').innerHTML = ''; 
                document.getElementById('rawPreview').innerHTML = '';
            }
        });

        const nyVilkaarNavnInput = document.getElementById('nyVilkaarNavn');
        const nyVilkaarTemplateInput = document.getElementById('nyVilkaarTemplate');
        const nyVilkaarNavnError = document.getElementById('nyVilkaarNavnError');
        const nyVilkaarTemplateError = document.getElementById('nyVilkaarTemplateError');
        const lagreNyVilkaarTypeKnapp = document.getElementById('lagreNyVilkaarTypeKnapp');
        const defaultNyVilkaarTemplate = "Eksempel vilkår: <anlegg type='vannkraft'> er kun tillatt å hente vann fra vassdrag <elv>."; 

        function setRetningslinjeInnhold() {
            const innhold = `
                <h4>Guide for å Lage Nye Vilkårstyper (Vilkårsgenerator Gen II - Markdown)</h4>
                <p>Bruk <code>&lt;placeholder&gt;</code> for dynamiske verdier. Enkel Markdown og noe HTML (<code>&lt;br&gt;</code>) kan brukes i teksten utenfor placeholders for formatering.</p>
                <h5>1. Grunnleggende Struktur</h5>
                <p>Eksempel: <code>Det skal betales &lt;beløp valuta='kr'&gt; til **staten**.</code></p>
                <h5>2. Hovedkategorier av Tagger</h5>
                <ul>
                    <li><strong>Entitets-Tags:</strong> For "ting" (<code>anlegg</code>, <code>aktør</code>, <code>elv</code>, <code>innsjø</code>, <code>dam</code>). Gir vanligvis en dropdown hvis <code>navn</code>-attributtet er utelatt eller tomt.</li>
                    <li><strong>Parameter-Tags:</strong> Alle andre tagger (<code>beløp</code>, <code>dato</code>, <code>frist</code>, egne). Gir vanligvis et input-felt hvis <code>verdi</code>-attributtet er utelatt eller tomt.</li>
                </ul>
                <h5>3. Entitets-Tags</h5>
                <p>For å få en dropdown for brukeren, utelat <code>navn</code> (og evt. <code>id</code> for anlegg/aktør). For å låse verdien, spesifiser <code>navn</code>.</p>
                <table class="table table-sm table-bordered">
                    <thead class="table-light"><tr><th>Tag</th><th>For Brukervalg (Dropdown)</th><th>For Fastsatt Verdi (Låst)</th></tr></thead>
                    <tbody>
                        <tr><td><code>anlegg</code></td><td><code>&lt;anlegg type='vannkraft'&gt;</code></td><td><code>&lt;anlegg navn='Navn' id='123' type='vannkraft'&gt;</code></td></tr>
                        <tr><td><code>aktør</code></td><td><code>&lt;aktør&gt;</code></td><td><code>&lt;aktør navn='Konsesjonær A'&gt;</code></td></tr>
                        <tr><td><code>elv</code></td><td><code>&lt;elv&gt;</code></td><td><code>&lt;elv navn='Glomma'&gt;</code></td></tr>
                        <tr><td><code>innsjø</code></td><td><code>&lt;innsjø&gt;</code></td><td><code>&lt;innsjø navn='Mjøsa'&gt;</code></td></tr>
                        <tr><td><code>dam</code></td><td><code>&lt;dam&gt;</code></td><td><code>&lt;dam navn='Røssvatnet dam'&gt;</code></td></tr>
                    </tbody>
                </table>
                <p>Attributtet <code>type</code> kan brukes på <code>&lt;anlegg&gt;</code> for å filtrere dropdown.</p>

                <h5>4. Parameter-Tags</h5>
                <p>Systemet lager et inputfelt for <code>verdi</code> hvis det ikke er spesifisert. For å låse verdien, skriv <code>verdi='dinVerdi'</code>.</p>
                <table class="table table-sm table-bordered">
                    <thead class="table-light"><tr><th>Eksempel i Mal</th><th>Resultat i UI</th></tr></thead>
                    <tbody>
                        <tr><td><code>&lt;beløp valuta='kr'&gt;</code></td><td>Input for beløp i kr.</td></tr>
                        <tr><td><code>&lt;frist metrikk='år' min=1 max=5&gt;</code></td><td>Input for tall (år, 1-5).</td></tr>
                        <tr><td><code>&lt;høyde metrikk='moh' type='laveste'&gt;</code></td><td>Input for tall (laveste høyde i moh).</td></tr>
                        <tr><td><code>&lt;farge valg='Rød|Grønn|Blå'&gt;</code></td><td>Dropdown med valgene Rød, Grønn, Blå.</td></tr>
                        <tr><td><code>&lt;kommentar&gt;</code></td><td>Tekstfelt.</td></tr>
                        <tr><td><code>&lt;standard_avgift valuta='NOK' verdi='250'&gt;</code></td><td>Ingen input; verdien "NOK 250,-" vises.</td></tr>
                    </tbody>
                </table>
                <p>Bruk <code>metrikk</code> (eller <code>valuta</code>), <code>format</code>, <code>min</code>, <code>max</code>, <code>valg='a|b'</code>, og <code>type</code> for å konfigurere feltet.</p>
                <h5>5. Markdown & HTML Formatering</h5>
                <ul>
                    <li><code>**Fet tekst**</code> &rarr; <strong>Fet tekst</strong></li>
                    <li><code>*Kursiv tekst*</code> &rarr; <em>Kursiv tekst</em></li>
                    <li><code># Overskrift 1</code> &rarr; Større overskrift</li>
                    <li><code>## Overskrift 2</code> &rarr; Mindre overskrift</li>
                    <li><code>- Punkt 1<br>- Punkt 2</code> &rarr; Punktliste (bruk <code style="white-space:pre;">  \n</code> for linjeskift i Markdown for <code style="white-space:pre;">&lt;br&gt;</code>, eller doble linjeskift for <code style="white-space:pre;">&lt;p&gt;</code>)</li>
                    <li><code>1. Punkt 1<br>2. Punkt 2</code> &rarr; Nummerert liste</li>
                    <li>Tabeller: <br><code>|| Hode1 || Hode2 ||</code><br><code>| R1C1 | R1C2 |</code><br><code>| R2C1 | R2C2 |</code></li>
                </ul>
            `;
            document.getElementById('retningslinjeInnhold').innerHTML = innhold;
        }


        function validateNyVilkaarTypeForm() {
            let i=true;nyVilkaarNavnError.textContent='';nyVilkaarTemplateError.textContent='';
            if(nyVilkaarNavnInput.value.trim()===''){nyVilkaarNavnError.textContent='Vilkårsnavn kan ikke være tomt.';i=false;}
            if(nyVilkaarTemplateInput.value.trim()===''){nyVilkaarTemplateError.textContent='Vilkårsråtekst kan ikke være tomt.';i=false;}
            lagreNyVilkaarTypeKnapp.disabled=!i;return i;
        }
        nyVilkaarNavnInput.addEventListener('input', validateNyVilkaarTypeForm);
        nyVilkaarTemplateInput.addEventListener('input', validateNyVilkaarTypeForm);
        
        document.getElementById('aapneNyVilkaarTypeModalKnapp').addEventListener('click', () => {
            if(!nyVilkaarTypeModalInstance)nyVilkaarTypeModalInstance=new bootstrap.Modal(document.getElementById('nyVilkaarTypeModal'));
            document.getElementById('nyVilkaarTypeSkjema').reset();
            nyVilkaarTemplateInput.value = defaultNyVilkaarTemplate; 
            nyVilkaarNavnError.textContent='';nyVilkaarTemplateError.textContent='';
            lagreNyVilkaarTypeKnapp.disabled=true;nyVilkaarTypeModalInstance.show();
        });

        document.getElementById('aapneRetningslinjeModalKnappNyType').addEventListener('click', () => {
            setRetningslinjeInnhold(); 
            if(!retningslinjeModalInstance) retningslinjeModalInstance = new bootstrap.Modal(document.getElementById('retningslinjeModal'));
            retningslinjeModalInstance.show();
        });
         document.getElementById('aapneRetningslinjeModalKnappHovedside').addEventListener('click', () => {
            setRetningslinjeInnhold(); 
            if(!retningslinjeModalInstance) retningslinjeModalInstance = new bootstrap.Modal(document.getElementById('retningslinjeModal'));
            retningslinjeModalInstance.show();
        });


        lagreNyVilkaarTypeKnapp.addEventListener('click', () => {
            if(!validateNyVilkaarTypeForm())return;
            const n=`egendefinert-${nesteEgendefinertId++}`,t=nyVilkaarNavnInput.value.trim(),e=nyVilkaarTemplateInput.value.trim();
            vilkaarstyper.push({id:n,label:t,template:e});populateVilkaarTypeSelect(true);nyVilkaarTypeModalInstance.hide();
        });
        
        function initTooltips() {
            activeTooltips.forEach(tooltip => tooltip.dispose()); activeTooltips = [];
            const tt = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tt.forEach(e => activeTooltips.push(new bootstrap.Tooltip(e, {html:true,sanitize:false,trigger:'hover'})));
        }

        document.addEventListener('DOMContentLoaded', () => { 
            populateVilkaarTypeSelect();
            const lagreKnapp = document.getElementById('lagreVilkårKnapp');
            if (lagreKnapp) lagreKnapp.disabled = true; 
            document.getElementById('vilkaarSkjema').addEventListener('submit', e => e.preventDefault());
            document.getElementById('nyVilkaarTypeSkjema').addEventListener('submit', e => e.preventDefault());
            initTooltips();
        });
    </script>
</body>
</html>